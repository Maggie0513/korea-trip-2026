<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>æˆ‘çš„æ—…è¡Œæ¸…å–® (Firebase Demo)</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"> 
    <style>
    body { 
        font-family: Arial, sans-serif; 
        padding: 0; 
        background-color: #f7f7f7; 
        margin: 0px; 
    }
    .container {
        max-width: 400px; 
        margin: 0 auto;
        padding: 10px 0px 20px 0px; 
        background-color: #FFF7FB; 
    }
    h1 { 
        color: #e91e63;
        text-align: left;
        margin-top: 0;
        margin-bottom: 12px;
        font-size: 24px;
    }
    
    .date-row {
        display: flex;
        justify-content: space-between;
        margin: 0;
        padding: 10px 0;
        background-color: #ffcdd2; 
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }
    .date-item {
        flex: 1;
        text-align: center;
        cursor: pointer;
        padding: 5px 0; 
        font-weight: bold;
        font-size: 14px;
        color: #f06292;
    }
    .date-item.selected {
        background-color: #f06292; 
        color: white;
        border-radius: 20px;
        margin: 0 5px;
    }
    
    #auth-button, #google-login-button {
        padding: 8px 15px;
        background-color: #00bcd4;
        color: white;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-size: 14px;
        margin-left: 10px;
        margin-bottom: 8px;
    }
    #google-login-button {
        background-color: #4285F4;
    }

    .time-input-group {
        display: flex;
        align-items: center;
        margin-bottom: 11px;
        font-size: 16px;
        font-weight: bold;
        color: #555;
    }
    .time-input-group input {
        margin-left: 10px;
        padding: 5px;
        border: 1px solid #ccc;
        border-radius: 4px;
    }

    .input-group {
        display: flex;
        margin-bottom: 10px;
        align-items: center;
    }
    .input-group-item {
        margin-bottom: 10px;
    }

    #new-item-input, #image-url-input { 
        padding: 12px; 
        flex-grow: 1;
        border: 1px solid #ccc;
        border-radius: 8px;
        font-size: 16px;
    }
    #add-button { 
        padding: 0; 
        cursor: pointer; 
        background-color: #9c27b0; 
        color: white; 
        border: none; 
        border-radius: 50%; 
        width: 40px;
        height: 40px;
        font-size: 26px;
        font-weight: bold;
        line-height: 40px; 
        text-align: center;
        margin-left: 10px;
        flex-shrink: 0;
    }

    .schedule-content {
        display: none;
    }
    .schedule-content.active {
        display: block;
    }
    .input-section {
        display: none;
    }
    .input-section.active {
        display: block;
    }
    
    ul { list-style: none; padding: 0; box-shadow: none; }
    li.schedule-item { 
        padding: 0; border-bottom: none; margin-bottom: 15px; display: block;
        border-radius: 8px; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); cursor: pointer;
    }
    .item-header {
        display: flex; justify-content: space-between; align-items: center;
        padding: 15px; background-color: #f7f7f7; border-radius: 8px; transition: border-radius 0.2s;
    }
    .schedule-item.open .item-header { border-radius: 8px 8px 0 0; border-bottom: 1px solid #ddd; }
    .item-name { font-weight: bold; color: #e91e63; flex-grow: 1; margin-left: 10px; font-size: 18px; }
    .item-time { font-weight: bold; color: #333; font-size: 16px; }
    
    .delete-btn {
        color: #ff7043; cursor: pointer; font-size: 1.2em; margin-left: 15px; flex-shrink: 0;
        display: none; 
    }
    .schedule-item.editable .delete-btn {
        display: inline; 
    }

    .item-details { display: none; padding: 15px; background-color: white; border-radius: 0 0 8px 8px; border: 1px solid #ddd; border-top: none; }
    .schedule-item.open .item-details { display: block; }

    .item-images { margin-top: 10px; overflow: hidden; border-radius: 4px; }
    .item-images img { max-width: 100%; height: auto; display: block; }
    </style>
</head>

<body>
    <div class="container">
        <div id="auth-status" style="margin-bottom: 20px; padding: 0 15px; display: flex; justify-content: space-between; align-items: center;">
            <h1 style="margin: 0;">ğŸŒ¸2026éŸ“åœ‹æ—…éŠğŸŒ¸</h1>
            <div style="display: flex; align-items: center; gap: 10px;">
                <span id="user-email-display" style="color: #4CAF50; font-weight: bold;">è¨ªå®¢æ¨¡å¼</span>
                <button id="auth-button">ç™»å…¥</button>
                <button id="google-login-button" style="display: none;">ç·¨è¼¯è¡Œç¨‹ (Google ç™»å…¥)</button>
            </div>
        </div>
        
        <h2 style="padding: 0 15px;">ğŸ—“ï¸ è¡Œç¨‹è¦åŠƒ</h2>

        <div class="date-row">
            <div class="date-item selected" data-date="2026-03-12">3/12 (å››)</div>
            <div class="date-item" data-date="2026-03-13">3/13 (äº”)</div>
            <div class="date-item" data-date="2026-03-14">3/14 (å…­)</div>
            <div class="date-item" data-date="2026-03-15">3/15 (æ—¥)</div>
            <div class="date-item" data-date="2026-03-16">3/16 (ä¸€)</div>
        </div>
        
        <div id="input-section" class="input-section" style="padding: 0 15px;">
            <div class="time-input-group">
                <span>é¸æ“‡æ™‚é–“:</span> <input type="time" id="time-input" value="12:00" />
            </div>
            <div class="input-group">
                <input type="text" id="new-item-input" placeholder="æ–°å¢è¡Œç¨‹åç¨±..." />
                <button id="add-button">+</button>
            </div>
            <div class="input-group-item">
                <input type="url" id="image-url-input" placeholder="é¸å¡«ï¼šè¼¸å…¥æ™¯é»åœ–ç‰‡ç¶²å€ (URL)..." />
            </div>
        </div>
        
        <div id="schedule-container" style="padding: 0 15px;"></div>
    </div>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>

    <script>
const firebaseConfig = {
    apiKey: "AIzaSyDy1AbtRBqhWyZSEhAC6JR7QXMM3EV-C8c",
    authDomain: "south-korea-37267.firebaseapp.com", 
    projectId: "south-korea-37267", 
};

firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const plansCollection = db.collection("trip_plans");
const auth = firebase.auth();

let currentlySelectedDate = "2026-03-12"; 

const authButton = document.getElementById('auth-button');
const googleLoginButton = document.getElementById('google-login-button');
const userEmailDisplay = document.getElementById('user-email-display');
const scheduleContainer = document.getElementById('schedule-container');
const inputSection = document.getElementById('input-section');
const googleProvider = new firebase.auth.GoogleAuthProvider(); 

function switchScheduleDisplay(targetDate) {
    document.querySelectorAll('.schedule-content').forEach(content => {
        content.classList.remove('active');
    });
    const targetContent = document.querySelector(`.schedule-content[data-date="${targetDate}"]`);
    if (targetContent) {
        targetContent.classList.add('active');
    }
}

authButton.addEventListener('click', () => {
    if (auth.currentUser) {
        auth.signOut();
    } else {
        googleLoginButton.style.display = 'inline-block';
        authButton.style.display = 'none';
    }
});

googleLoginButton.addEventListener('click', () => {
    auth.signInWithPopup(googleProvider) 
        .then((result) => {
            console.log("Google ç™»å…¥æˆåŠŸ:", result.user.email);
        })
        .catch((error) => {
            console.error("Google ç™»å…¥å¤±æ•—: ", error.message);
            alert("ç™»å…¥å¤±æ•—ï¼Œå¯èƒ½æ‚¨ä¸åœ¨å…è¨±ç·¨è¼¯åå–®ä¸­ï¼ŒéŒ¯èª¤è¨Šæ¯: " + error.code);
        });
});

document.querySelectorAll('.date-item').forEach(dateItem => {
    dateItem.addEventListener('click', (e) => {
        const currentSelected = document.querySelector('.date-item.selected');
        if (currentSelected) {
            currentSelected.classList.remove('selected');
        }
        e.currentTarget.classList.add('selected');
        currentlySelectedDate = e.currentTarget.getAttribute('data-date');
        switchScheduleDisplay(currentlySelectedDate);
    });
});

document.getElementById("add-button").addEventListener('click', () => {
    if (!auth.currentUser) {
        alert("æ‚¨æ²’æœ‰ç·¨è¼¯æ¬Šé™ï¼Œè«‹å…ˆä½¿ç”¨å…è¨±çš„ Google å¸³è™Ÿç™»å…¥ï¼");
        return;
    }
    const input = document.getElementById("new-item-input");
    const timeInput = document.getElementById("time-input");
    const imageUrlInput = document.getElementById("image-url-input"); 
    const itemName = input.value.trim();
    const selectedTime = timeInput.value;
    const selectedDate = currentlySelectedDate;
    const imageUrl = imageUrlInput.value.trim(); 
    if (itemName && selectedDate && selectedTime) {
        plansCollection.add({
            name: itemName,
            date: selectedDate,
            time: selectedTime,
            imageUrl: imageUrl, 
            userId: auth.currentUser.uid,
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
        })
        .then(() => {
            input.value = ''; 
            imageUrlInput.value = ''; 
        })
        .catch((error) => {
            console.error("å¯«å…¥éŒ¯èª¤: ", error);
            alert("æ–°å¢å¤±æ•—ï¼šæ‚¨å¯èƒ½ä¸åœ¨å…è¨±ç·¨è¼¯åå–®ä¸­ã€‚");
        });
    } else {
        alert("è«‹å¡«å¯«è¡Œç¨‹åç¨±ã€æ—¥æœŸå’Œæ™‚é–“ã€‚");
    }
});

function handleScheduleSnapshot(snapshot) {
    const isEditable = !!auth.currentUser;
    scheduleContainer.innerHTML = ''; 
    const groupedPlans = {};
    snapshot.forEach((doc) => {
        const plan = doc.data();
        const date = plan.date; 
        if (!groupedPlans[date]) {
            groupedPlans[date] = [];
        }
        groupedPlans[date].push({ id: doc.id, imageUrl: plan.imageUrl || '', ...plan });
    });
    for (const date in groupedPlans) {
        const dateContentWrapper = document.createElement("div");
        dateContentWrapper.classList.add('schedule-content'); 
        dateContentWrapper.setAttribute('data-date', date);
        if (date === currentlySelectedDate) {
            dateContentWrapper.classList.add('active');
        }
        const dateCard = document.createElement("div");
        const displayDate = new Date(date).toLocaleDateString('zh-TW', { month: '2-digit', day: '2-digit' });
        dateCard.innerHTML = `
            <h3 style="color: #4CAF50;">ğŸ“… ${displayDate} çš„è¡Œç¨‹</h3>
            <ul id="list-${date}"></ul>
        `;
        dateContentWrapper.appendChild(dateCard);
        scheduleContainer.appendChild(dateContentWrapper);
        const listElement = dateContentWrapper.querySelector('ul');
        groupedPlans[date].forEach(item => {
            const li = document.createElement("li");
            li.classList.add('schedule-item'); 
            if (isEditable) {
                li.classList.add('editable');
            }
            const isValidUrl = item.imageUrl && item.imageUrl.startsWith('http');
            const finalImageUrl = isValidUrl
                ? item.imageUrl 
                : 'https://via.placeholder.com/300x150?text=' + encodeURIComponent(item.name || 'ç„¡åœ–ç‰‡');
            li.innerHTML = `
                <div class="item-header">
                    <span class="item-time">${item.time}</span>
                    <span class="item-name">${item.name}</span>
                    <span class="delete-btn" data-id="${item.id}">ğŸ—‘ï¸</span>
                </div>
                <div class="item-details" data-id="${item.id}">
                    <div class="item-images">
                        <img src="${finalImageUrl}" alt="${item.name}åœ–ç‰‡">
                    </div>
                </div>
            `;
            listElement.appendChild(li);
        });
    }
    document.querySelectorAll('.delete-btn').forEach(button => {
        button.addEventListener('click', (e) => {
            e.stopPropagation(); 
            if (!isEditable) {
                alert("æ‚¨æ²’æœ‰åˆªé™¤æ¬Šé™ï¼");
                return;
            }
            const idToDelete = e.target.getAttribute('data-id');
            plansCollection.doc(idToDelete).delete()
                .catch((error) => {
                    alert("åˆªé™¤å¤±æ•—ï¼šæ‚¨å¯èƒ½ä¸åœ¨å…è¨±ç·¨è¼¯åå–®ä¸­ã€‚");
                });
        });
    });
    document.querySelectorAll('.schedule-item').forEach(item => {
        item.addEventListener('click', (e) => {
            const currentItem = e.currentTarget;
            currentItem.classList.toggle('open'); 
        });
    });
    switchScheduleDisplay(currentlySelectedDate);
}

plansCollection.orderBy("date").orderBy("time").onSnapshot(handleScheduleSnapshot);

auth.onAuthStateChanged(user => {
    if (user) {
        userEmailDisplay.textContent = `ç·¨è¼¯è€…: ${user.email}`;
        authButton.textContent = 'ç™»å‡º';
        authButton.style.display = 'inline-block';
        googleLoginButton.style.display = 'none';
        inputSection.style.display = 'block'; 
        document.querySelectorAll('.schedule-item').forEach(li => li.classList.add('editable'));
    } else {
        userEmailDisplay.textContent = 'è¨ªå®¢æ¨¡å¼';
        authButton.textContent = 'ç™»å…¥';
        authButton.style.display = 'inline-block';
        googleLoginButton.style.display = 'none'; 
        inputSection.style.display = 'none'; 
        document.querySelectorAll('.schedule-item').forEach(li => li.classList.remove('editable'));
    }
});
    </script>
</body>
</html>